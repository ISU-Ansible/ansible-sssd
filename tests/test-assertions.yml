---
- hosts: localhost
  remote_user: root

  vars:
    sssd_domains:
      - name: "LOCAL"
        id_provider: local
      - name: "Test"
        id_provider: "ad"
        domain_type: "ad"
  roles:
    - role_under_test

  tasks:
    - name: "[Test] Does Configuration File Exist?"
      stat:
        path: "{{ sssd_configuration_file.filename }}"
      register: sssd_conf

    - name: "[Test] Test File Defaults"
      shell: "cat {{ sssd_configuration_file }}"
      when: sssd_conf.stat.exists
      register: sssd_conf_contents

    - name: "[Test] Test domains"
      shell: "cat /etc/sssd/conf.d/domains.conf"
      register: sssd_domains_contents

    - debug:
        var: sssd_domains_contents

    - assert:
        that:
          - "sssd_conf_contents.rc == 0"
          - "sssd_domains_contents.stdout.find('id_provider = ad')"
          - "sssd_conf_contents.stdout.find('access_provider = permit')"
